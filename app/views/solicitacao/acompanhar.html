{% extends 'layouts/layout.html' %}

{% block content %}
<div class="content-wrapper">
    <main class="container">
        <h1 class="titulo-pagina">Minhas Solicita√ß√µes</h1>

        <!-- üîπ Filtro por status -->
        <form class="formulario-filtros" method="GET" action="/" style="margin-bottom: 20px;">
            <label for="status_filter" style="font-weight: 600; margin-right: 10px;">Filtrar por Status:</label>
            <select name="status" id="status_filter" onchange="this.form.submit()" class="select-filtro">
                <option value="" {% if not filtro_ativo %}selected{% endif %}>Todos</option>
                <option value="Pendente" {% if filtro_ativo == 'Pendente' %}selected{% endif %}>Pendente</option>
                <option value="Em An√°lise" {% if filtro_ativo == 'Em An√°lise' %}selected{% endif %}>Em An√°lise</option>
                <option value="Agendada" {% if filtro_ativo == 'Agendada' %}selected{% endif %}>Agendada</option>
                <option value="Em Andamento" {% if filtro_ativo == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
                <option value="Conclu√≠da" {% if filtro_ativo == 'Conclu√≠da' %}selected{% endif %}>Conclu√≠da</option>
                <option value="Cancelado" {% if filtro_ativo == 'Cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
        </form>

        <div class="table-responsive">
            <table id="tabela-solicitacoes" class="display tabela-solicitacoes"> 
                <thead>
                    <tr>
                        <th>Protocolo</th>
                        <th>Categoria</th>
                        <th>Rua</th>
                        <th>Bairro</th>
                        <th>Gravidade</th>
                        <th>Status</th>
                        <th>Data Agendada</th>
                        <th>Data de Conclus√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in solicitacoes %}
                    <tr>
                        <td>#{{ s.id }}</td>
                        <td>{{ s.categoria }}</td>
                        <td>{{ s.rua }}<span class="endereco-complemento">, {{ s.numero }}</span></td>
                        <td>{{ s.bairro }}</td>
                        <td>
                            {% if s.gravidade == 'Baixa' %}
                                <span class="status-pill gravidade-baixa">Baixa</span>
                            {% elif s.gravidade == 'M√©dia' %}
                                <span class="status-pill gravidade-media">M√©dia</span>
                            {% elif s.gravidade == 'Alta' %}
                                <span class="status-pill gravidade-alta">Alta</span>
                            {% else %}
                                {{ s.gravidade }}
                            {% endif %}
                        </td>
                        <td>
                            {% if s.status == 'Pendente' %}
                                <span class="status-pill status-pendente">Pendente</span>
                            {% elif s.status == 'Em An√°lise' %}
                                <span class="status-pill status-em-analise">Em An√°lise</span>
                            {% elif s.status == 'Agendada' %}
                                <span class="status-pill status-agendada">Agendada</span>
                            {% elif s.status == 'Em Andamento' %}
                                <span class="status-pill status-em-andamento">Em Andamento</span>
                            {% elif s.status == 'Conclu√≠da' %}
                                <span class="status-pill status-concluida">Conclu√≠da</span>
                            {% elif s.status == 'Cancelado' %}
                                <span class="status-pill status-cancelado">Cancelado</span>
                            {% else %}
                                {{ s.status }}
                            {% endif %}
                        </td>
                        <td>
                            {% if s.data_agendamento %}
                                {{ s.data_agendamento.strftime('%d/%m/%Y') }}
                            {% else %}
                                N√£o agendada
                            {% endif %}
                        </td>
                        <td>
                            {% if s.data_finalizacao %}
                                {{ s.data_finalizacao.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="actions">
                            <a class="acoes view" 
                               title="Ver detalhes" 
                               href="#"
                               data-id="#{{ s.id }}"
                               data-categoria="{{ s.categoria }}"
                               data-rua="{{ s.rua }}"
                               data-numero="{{ s.numero }}"
                               data-bairro="{{ s.bairro }}"
                               data-gravidade="{{ s.gravidade }}"
                               data-status="{{ s.status }}"
                               data-data-agendada="{% if s.data_agendamento %}{{ s.data_agendamento.strftime('%d/%m/%Y') }}{% else %}N√£o agendada{% endif %}"
                               data-data-finalizacao="{% if s.data_finalizacao %}{{ s.data_finalizacao.strftime('%d/%m/%Y') }}{% else %}-{% endif %}"
                               data-descricao="{{ s.descricao if s.descricao else 'Sem descri√ß√£o dispon√≠vel.' }}"
                               data-feedback="Muito bom"

                               {% if s.id == 1 %}
                                   {% if s.status == 'Conclu√≠da' %}
                                       data-foto-url-before="{{ url_for('static', filename='img/boca_lobo1.jpeg') }}"
                                       data-foto-url-after="{{ url_for('static', filename='img/boca_lobo1resolved.png') }}"
                                   {% else %}
                                       data-foto-url-before="{{ url_for('static', filename='img/boca_lobo1.jpeg') }}"
                                   {% endif %}
                               {% elif s.id == 2 %}
                                   data-foto-url-before="{{ url_for('static', filename='img/boca_lobo2.jpeg') }}"
                               {% else %}
                                   data-foto-url-before="{{ url_for('static', filename='img/boca_lobo.jpeg') }}"
                               {% endif %}
                            >
                                <i class="fa-solid fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center;">Nenhuma solicita√ß√£o encontrada com o status "{{ filtro_ativo }}".</td> 
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- üîπ Modal Detalhes -->
    <div id="detalhesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Detalhes da Solicita√ß√£o <span id="modal-protocolo"></span></h2>
            <div class="modal-body">
                <div class="detalhes-texto">
                    <p><strong>Categoria:</strong> <span id="modal-categoria"></span></p>
                    <p><strong>Endere√ßo:</strong> <span id="modal-endereco"></span></p>
                    <p><strong>Bairro:</strong> <span id="modal-bairro"></span></p>
                    <p><strong>Gravidade:</strong> <span id="modal-gravidade"></span></p>
                    <p><strong>Status:</strong> <span id="modal-status"></span></p>
                    <p><strong>Data Agendada:</strong> <span id="modal-data-agendada"></span></p>

                    <div id="conclusao-section" style="display: none;">
                        <p><strong>Data de Conclus√£o:</strong> <span id="modal-data-finalizacao"></span></p>
                        <p><strong>Feedback:</strong> <span id="modal-feedback"></span></p>
                    </div>

                    <p><strong>Descri√ß√£o:</strong> <span id="modal-descricao"></span></p>
                </div>

                <!-- üîπ Fotos -->
                <div class="detalhes-foto" id="foto-container">
                    <div id="foto-single" style="text-align: center;">
                        <h3>Foto da Solicita√ß√£o</h3>
                        <img id="modal-foto" src="" alt="Foto da Solicita√ß√£o" class="foto-solicitacao">
                    </div>

                    <div id="foto-dupla" class="foto-dupla-container" style="display: none;">
                        <div class="foto-bloco">
                            <h4>Antes</h4>
                            <img id="modal-foto-before" src="" alt="Foto Antes" class="foto-solicitacao">
                        </div>
                        <div class="foto-bloco">
                            <h4>Depois</h4>
                            <img id="modal-foto-after" src="" alt="Foto Depois" class="foto-solicitacao">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

<script type="text/javascript">
$(document).ready(function() {
    $('#tabela-solicitacoes').DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' },
        pageLength: 10,
        order: [[0, 'desc']],
        searching: true,
        paging: true,
        info: true
    });

    var modal = $('#detalhesModal');
    var closeBtn = $('.close-btn');

    $('#tabela-solicitacoes tbody').on('click', '.view', function(e) {
        e.preventDefault(); 
        var link = $(this);

        $('#modal-protocolo').text(link.data('id'));
        $('#modal-categoria').text(link.data('categoria'));
        $('#modal-endereco').text(link.data('rua') + (link.data('numero') ? ', ' + link.data('numero') : ''));
        $('#modal-bairro').text(link.data('bairro'));
        $('#modal-gravidade').text(link.data('gravidade'));
        $('#modal-status').text(link.data('status'));
        $('#modal-data-agendada').text(link.data('data-agendada'));
        $('#modal-descricao').text(link.data('descricao'));
        $('#modal-feedback').text(link.data('feedback'));

        if (link.data('status') === 'Conclu√≠da') {
            $('#conclusao-section').show();
            $('#modal-data-finalizacao').text(link.data('data-finalizacao'));
            $('#foto-single').hide();
            $('#foto-dupla').show();
            $('#modal-foto-before').attr('src', link.data('foto-url-before'));
            $('#modal-foto-after').attr('src', link.data('foto-url-after'));
        } else {
            $('#conclusao-section').hide();
            $('#foto-dupla').hide();
            $('#foto-single').show();
            $('#modal-foto').attr('src', link.data('foto-url-before'));
        }

        modal.css('display', 'block');
    });

    closeBtn.on('click', function() { modal.css('display', 'none'); });
    $(window).on('click', function(e) {
        if (e.target == modal[0]) modal.css('display', 'none');
    });
});
</script>
{% endblock %}
